---
title: "diagnostics"
author: "Jeffrey Brennan"
date: "7/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggpubr)
```

# TS & RT Thresholds

```{r}
mydata = county.Daily
maxdate = max(mydata$Date)
case_features = subset(mydata, Date >= maxdate-14) %>%
  group_by(Level_Name) %>%
  mutate(criteria1 = mean(Cases_Daily)) %>% 
  mutate(criteria2 = mean(Cases_Cumulative)) %>% 
  mutate(criteria3 = (mean(Cases_Cumulative) / Population_DSHS)) %>%
  dplyr::select(Level_Name, Date, criteria1, criteria2, criteria3, PHR, TSA)

criteria1_vals = subset(case_features, Date == maxdate) %>% 
  group_by(Date) %>% 
  do(data.frame(t(quantile(.$criteria1, probs = c(0.4, 0.5, 0.6, 0.7, 0.8)))))

criteria1_features = merge(criteria1_vals, case_features, by = 'Date')

ggplot(subset(criteria1_features, Date == maxdate), aes(y = Level_Name, x = criteria1)) + 
  geom_point() + 
  geom_vline(xintercept = criteria1_features$X40[1], color = 'red') +
  geom_vline(xintercept = criteria1_features$X50.[1], color = 'orange') + 
  geom_vline(xintercept = criteria1_features$X60.[1], color = 'green') + 
  geom_vline(xintercept = criteria1_features$X70.[1], color = 'blue') + 
  geom_vline(xintercept = criteria1_features$X80.[1], color = 'purple') + 
  labs(title = paste0('mean(Cases_Daily) by county quantile (Data from: ', maxdate-14, ')'),
       subtitle = paste0('40%: ', round(criteria1_features$X40.[1], 2), ' | ',
                         '50%: ', round(criteria1_features$X50.[1], 2), ' | ',
                         '60%: ', round(criteria1_features$X60.[1], 2), ' |',
                         '70%: ', round(criteria1_features$X70.[1], 2), ' | ',
                         '80%: ', round(criteria1_features$X80.[1], 2)),
       x = '', y ='') +
  facet_wrap(~TSA, scales = 'free') +
  ggpubr::theme_pubr(border = TRUE) +
  theme(axis.text.y = element_text(size = 5)) + 
  theme(axis.text.x = element_text(size = 6))
ggsave('statistical-output/time-series/diagnostics/threshold1.png', width = 10, height = 10, dpi = 600)
```


# DSHS VS HHS 

```{r}
state = openxlsx::read.xlsx('combined-datasets/state.xlsx', sheet = 1)

state_compare = state %>%
  mutate(Date = openxlsx::convertToDate(Date)) %>%
  select(c(Date, grep('Hospitalizations_|Beds_', colnames(state)),
           HHS_Inpatient.Beds.Occupied.Estimated, HHS_Inpatient.Beds.Occupied.by.COVID.19.Patients.Estimated,
           HHS_ICU.Beds.Occupied.Estimated)) %>% 
  na.omit()

ggplot(state_compare, aes(x = Date)) + 
  geom_point(aes(y = Beds_Occupied_Total, color = 'DSHS'), size = 2) + 
  geom_point(aes(y = HHS_Inpatient.Beds.Occupied.Estimated, color = 'HHS Estimate'), size = 2) + 
  labs(y = 'Beds', title = 'Beds Occupied',
       subtitle = paste0('DSHS: Total Beds Occupied by Trauma Service Area\n',
                         'HHS: Estimated number of inpatient beds occupied for the given state and date')) +
  scale_color_manual('', values = c('blue', 'red'), labels = c('DSHS', 'HHS Estimate')) + 
  theme_pubr()

ggplot(state_compare, aes(x = Date)) + 
  geom_point(aes(y = Hospitalizations_General, color = 'DSHS'), size = 2) + 
  geom_point(aes(y = HHS_Inpatient.Beds.Occupied.by.COVID.19.Patients.Estimated, color = 'HHS Estimate'), size = 2) + 
  labs(y = 'Beds', title = 'COVID Beds Occupied', 
  subtitle = paste0('DSHS: Lab-Confirmed COVID-19 Hospitalized Patients (General) by Trauma Service Area (TSA)\n',
                    'HHS: Estimated number of inpatient beds occupied by COVID-19 patients')) + 
  scale_color_manual('', values = c('blue', 'red'), labels = c('DSHS', 'HHS Estimate')) + 
  theme_pubr()


ggplot(state_compare, aes(x = Date)) + 
  geom_point(aes(y = Beds_Occupied_ICU, color = 'DSHS'), size = 2) + 
  geom_point(aes(y = HHS_ICU.Beds.Occupied.Estimated, color = 'HHS Estimate'), size = 2) + 
  labs(y = 'Beds', title = 'ICU Beds Occupied',
       subtitle = paste0('DSHS: Total ICU Beds Occupied by Trauma Service Area (TSA)\n',
                         'HHS: Estimated number of ICU beds occupied for the given state and date')) + 
  scale_color_manual('', values = c('blue', 'red'), labels = c('DSHS', 'HHS Estimate')) + 
  theme_pubr()


ggplot(state, aes(x = Date, y = )) + 
  geom_point(aes(y = Beds_Occupied_ICU, color = 'DSHS'), size = 2) + 
  geom_point(aes(y = HHS_ICU.Beds.Occupied.Estimated, color = 'HHS Estimate'), size = 2) + 
  labs(y = 'Beds', title = 'ICU Beds Occupied',
       subtitle = paste0('DSHS: Total ICU Beds Occupied by Trauma Service Area (TSA)\n',
                         'HHS: Estimated number of ICU beds occupied for the given state and date')) + 
  scale_color_manual('', values = c('blue', 'red'), labels = c('DSHS', 'HHS Estimate')) + 
  theme_pubr()


```

